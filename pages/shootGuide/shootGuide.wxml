<!-- 标准化拍摄页面 -->
<view class="container safe-area-bottom">
  <!-- 内容区域 -->
  <scroll-view class="content safe-area-padding" scroll-y="true" 
               bindtouchstart="onTouchStart" 
               bindtouchmove="onTouchMove" 
               bindtouchend="onTouchEnd">
    <!-- ==================== 拍摄进度信息行 ==================== -->
    <view class="progress-header">
      <text class="header-text">拍摄流程</text>
      <view class="swipe-indicator">
        <text class="swipe-text">左右滑动切换步骤</text>
      </view>
      <text class="header-status">已完成 {{shootProgress.completedSteps}}/{{shootProgress.totalSteps}} 步</text>
    </view>

    <!-- ==================== 摄像头预览区域 ==================== -->
    <view class="preview-section-wrapper">
      <view class="preview-section">
        <!-- 三种互斥的预览模式 -->
        
        <!-- 默认预览模式 -->
        <view wx:if="{{!showCameraPreview && !selectedMedia.url}}" class="preview-mode default-preview">
          <image class="preview-image" src="{{currentPreviewImage}}" mode="aspectFill"></image>
        </view>
        
        <!-- 摄像头预览模式 -->
        <view wx:if="{{showCameraPreview}}" class="preview-mode camera-preview">
          <camera class="camera-preview" device-position="{{cameraPosition}}"></camera>
        </view>
        
        <!-- 媒体预览模式 -->
        <view wx:if="{{selectedMedia.url}}" class="preview-mode media-preview">
          <!-- 媒体预览但未播放状态 -->
          <block wx:if="{{!selectedMedia.shouldPlay}}">
            <image wx:if="{{selectedMedia.type === 'image'}}" class="media-preview" src="{{selectedMedia.url}}" mode="aspectFill"></image>
            <video wx:if="{{selectedMedia.type === 'video'}}" class="media-preview" src="{{selectedMedia.url}}" show-center-play-btn="{{true}}" controls="{{false}}" show-play-btn="{{false}}" enable-play-gesture="{{false}}" bindplay="onVideoPlay" binderror="onVideoError"></video>
            <!-- 播放按钮覆盖层 -->
            <view class="play-overlay" bindtap="onPlayMedia">
              <view class="play-button">
                <icon wx:if="{{selectedMedia.type === 'video'}}" type="play" size="40" color="#ffffff"></icon>
              </view>
            </view>
          </block>
          
          <!-- 媒体播放状态 -->
          <block wx:else>
            <image wx:if="{{selectedMedia.type === 'image'}}" class="media-player" src="{{selectedMedia.url}}" mode="aspectFill"></image>
            <video wx:if="{{selectedMedia.type === 'video'}}" class="media-player" src="{{selectedMedia.url}}" autoplay="{{true}}" controls="{{true}}" show-center-play-btn="{{false}}" enable-play-gesture="{{true}}" object-fit="contain" bindplay="onVideoPlay" binderror="onVideoError"></video>
          </block>
        </view>
        
        <view class="preview-overlay"></view>
        
        <!-- 提示文案 -->
        <view class="preview-tip">
          <view class="tip-banner">
            <icon class="tip-icon" type="lightbulp" size="10" color="#fbbf24"></icon>
            <text class="tip-text">{{currentTip}}</text>
          </view>
          <view class="tip-content">
            <text class="tip-title">{{currentSubStepTitle}}</text>
            <text class="tip-desc">{{currentSubStepDesc}}</text>
          </view>
        </view>

        <!-- 底部进度与重拍 -->
        <view class="preview-footer">
          <view class="fragment-info">
            <text class="fragment-text">当前片段：{{currentFragmentTime}}s / 建议 {{recommendedFragmentTime}}s</text>
          </view>
          <button class="retake-button" bindtap="onRetake">重拍本段</button>
        </view>
      </view>
    </view>

    <!-- ==================== 子步骤列表区域 ==================== -->
    <view class="steps-section">
      <view class="section-header">
        <text class="header-text">当前步骤：{{shootProgress.steps[shootProgress.currentStep-1].name}}</text>
        <text class="header-subtext">建议 {{currentStepSubSteps.length}} 个小段</text>
      </view>
      
      <view class="steps-list">
        <block wx:for="{{currentStepSubSteps}}" wx:key="id">
          <view class="step-item {{item.status}}">
            <view class="step-content">
              <!-- 点击step-info区域查看已完成的媒体内容 -->
              <view class="step-info" bindtap="onSelectMedia" data-substep-id="{{item.id}}">
                <view class="step-number {{item.status}} fixed-width">
                  <text class="number-text">{{item.id}}</text>
                </view>
                <view class="step-desc">
                  <text class="desc-title">{{item.title}}</text>
                  <text class="desc-subtitle">{{item.subtitle}}</text>
                </view>
              </view>
              <button wx:if="{{item.status !== 'completed'}}" class="step-action {{item.status}}" bindtap="onShoot" data-substep-id="{{item.id}}">{{item.status === 'completed' ? '已完成' : '去拍摄'}}</button>
              <text wx:else class="step-completed">已完成</text>
            </view>
          </view>
        </block>
      </view>

      <!-- 下一个主步骤提示 -->
      <!-- 已根据需求移除此部分 -->
    </view>
  </scroll-view>

  <!-- ==================== 底部拍摄控制区域 ==================== -->
  <view wx:if="{{showCameraControls}}" class="camera-control-bar safe-area-padding">
    <view class="control-buttons-container">
      <!-- 切换摄像头按钮 -->
      <button class="control-button switch-camera {{isRecording ? 'disabled' : ''}}" bindtap="onRotate" disabled="{{isRecording}}">
        <image class="icon-image" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cGF0aCBkPSJNMTAuNSAxMi41TDcgOU03IDlMMTAuNSA1LjVNNSA5SDEzQzE0LjY1NjkgOSAxNiAxMC4zNDMxIDE2IDEyTTIxLjUgMTkuNUwyNSAyM00yNSAyM0wyMS41IDI2LjVNMjUgMjNIMTlDMTcuMzQzMSAyMyAxNiAyMS42NTY5IDE2IDIwTTkgMTZDOSAxNy42NTY5IDEwLjM0MzEgMTkgMTIgMTlDMTMuNjU2OSAxOSAxNSAxNy42NTY5IDE1IDE2QzE1IDE0LjM0MzEgMTMuNjU2OSAxMyAxMiAxM0MxMC4zNDMxIDEzIDkgMTQuMzQzMSA5IDE2WiIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIHN0cm9rZS1vcGFjaXR5PSIwLjkiLz4KPC9zdmc+" mode="aspectFit" />
      </button>
      
      <!-- 录制按钮 -->
      <button class="record-button {{isRecording ? 'recording' : ''}} {{mode == 'photo' ? 'photo-mode' : 'video-mode'}}" 
              bindtouchstart="onRecordTouchStart" 
              bindtouchend="onRecordTouchEnd"
              bindtouchcancel="onRecordTouchCancel">
        <!-- 拍照模式：白色实心圆 -->
        <view wx:if="{{mode == 'photo'}}" class="record-inner photo-inner"></view>
        <!-- 录像模式：红色圆点 -->
        <view wx:elif="{{mode == 'video' && !isRecording}}" class="record-inner video-inner"></view>
        <!-- 录像进行中：红色圆角方块 + 呼吸动画 -->
        <view wx:elif="{{isRecording}}" class="record-inner recording-inner"></view>
        <!-- 录制进度环 -->
        <view class="record-progress-ring" style="background: conic-gradient(rgba(239, 68, 68, 0.8) {{recordingDuration * 360 / maxRecordingDuration}}deg, transparent 0deg);"></view>
        <!-- 录制时长显示 -->
        <view wx:if="{{isRecording}}" class="recording-duration">
          <text>{{recordingDuration}}</text>
        </view>
      </button>
      
      <!-- 相册按钮 -->
      <button class="control-button album {{isRecording ? 'disabled' : ''}}" bindtap="onOpenAlbum" disabled="{{isRecording}}">
        <image class="icon-image" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB4PSI1IiB5PSI4IiB3aWR0aD0iMjIiIGhlaWdodD0iMTYiIHJ4PSIyIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1vcGFjaXR5PSIwLjkiLz4KICA8Y2lyY2xlIGN4PSIxMiIgY3k9IjE2IiByPSIyIiBmaWxsPSJ3aGl0ZSIgZmlsbC1vcGFjaXR5PSIwLjkiLz4KICA8cGF0aCBkPSJNNSAyNEwxMiAxOEwxNiAyMUwyMSAxNkwyNyAyNCIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIHN0cm9rZS1vcGFjaXR5PSIwLjkiLz4KPC9zdmc+" mode="aspectFit" />
      </button>
    </view>
  </view>
</view>
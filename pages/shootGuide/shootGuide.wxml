<!-- 标准化拍摄页面 -->
<view class="container safe-area-bottom">
  <!-- 内容区域 -->
  <scroll-view class="content safe-area-padding" scroll-y="true">
    <!-- ==================== 拍摄进度条区域 ==================== -->
    <view class="progress-section">
      <view class="progress-header">
        <text class="header-text">拍摄流程</text>
        <text class="header-status">已完成 {{shootProgress.completedSteps}}/{{shootProgress.totalSteps}} 步</text>
      </view>
      <view class="progress-container">
        <view class="progress-steps">
          <block wx:for="{{shootProgress.steps}}" wx:key="id">
            <view class="step-wrapper {{item.status}}" data-step="{{item.id}}">
              <view class="step-indicator {{item.status}}">
                <icon wx:if="{{item.status === 'completed'}}" class="step-icon" type="success" size="11" color="#ffffff"></icon>
                <text wx:else class="step-number">{{item.id}}</text>
              </view>
              <view wx:if="{{item.id < shootProgress.totalSteps}}" class="step-line {{item.status}}"></view>
            </view>
          </block>
        </view>
        <view class="step-labels">
          <text class="label-text left">外观</text>
          <text class="label-text center">内饰</text>
          <text class="label-text right">亮点</text>
        </view>
      </view>
    </view>

    <!-- ==================== 摄像头预览区域 ==================== -->
    <view class="preview-section-wrapper">
      <view class="preview-section">
        <!-- 三种互斥的预览模式 -->
        
        <!-- 默认预览模式 -->
        <view wx:if="{{!showCameraPreview && !selectedMedia.url}}" class="preview-mode default-preview">
          <image class="preview-image" src="{{currentPreviewImage}}" mode="aspectFill"></image>
        </view>
        
        <!-- 摄像头预览模式 -->
        <view wx:if="{{showCameraPreview}}" class="preview-mode camera-preview">
          <camera class="camera-preview" device-position="{{cameraPosition}}"></camera>
        </view>
        
        <!-- 媒体预览模式 -->
        <view wx:if="{{selectedMedia.url}}" class="preview-mode media-preview">
          <!-- 媒体预览但未播放状态 -->
          <block wx:if="{{!selectedMedia.shouldPlay}}">
            <image wx:if="{{selectedMedia.type === 'image'}}" class="media-preview" src="{{selectedMedia.url}}" mode="aspectFill"></image>
            <video wx:if="{{selectedMedia.type === 'video'}}" class="media-preview" src="{{selectedMedia.url}}"></video>
            <!-- 播放按钮覆盖层 -->
            <view class="play-overlay" bindtap="onPlayMedia">
              <view class="play-button">
                <icon wx:if="{{selectedMedia.type === 'video'}}" type="play" size="40" color="#ffffff"></icon>
              </view>
            </view>
          </block>
          
          <!-- 媒体播放状态 -->
          <block wx:else>
            <image wx:if="{{selectedMedia.type === 'image'}}" class="media-player" src="{{selectedMedia.url}}" mode="aspectFill"></image>
            <video wx:if="{{selectedMedia.type === 'video'}}" class="media-player" src="{{selectedMedia.url}}" autoplay controls></video>
          </block>
        </view>
        
        <view class="preview-overlay"></view>
        
        <!-- 提示文案 -->
        <view class="preview-tip">
          <view class="tip-banner">
            <icon class="tip-icon" type="lightbulp" size="10" color="#fbbf24"></icon>
            <text class="tip-text">{{currentTip}}</text>
          </view>
          <text class="tip-title">步骤 {{shootProgress.currentStep}} / {{shootProgress.totalSteps}} · {{shootProgress.steps[shootProgress.currentStep-1].name}} - {{currentSubStepTitle}}</text>
          <text class="tip-desc">{{currentSubStepDesc}}</text>
        </view>

        <!-- 底部进度与重拍 -->
        <view class="preview-footer">
          <view class="fragment-info">
            <text class="fragment-text">当前片段：{{currentFragmentTime}}s / 建议 {{recommendedFragmentTime}}s</text>
          </view>
          <button class="retake-button" bindtap="onRetake">重拍本段</button>
        </view>
      </view>
    </view>

    <!-- ==================== 子步骤列表区域 ==================== -->
    <view class="steps-section">
      <view class="section-header">
        <text class="header-text">当前步骤：{{shootProgress.steps[shootProgress.currentStep-1].name}}</text>
        <text class="header-subtext">建议 {{currentStepSubSteps.length}} 个小段</text>
      </view>
      
      <view class="steps-list">
        <block wx:for="{{currentStepSubSteps}}" wx:key="id">
          <view class="step-item {{item.status}}">
            <view class="step-content">
              <!-- 点击step-info区域查看已完成的媒体内容 -->
              <view class="step-info" bindtap="onSelectMedia" data-substep-id="{{item.id}}">
                <view class="step-number {{item.status}} fixed-width">
                  <text class="number-text">{{item.id}}</text>
                </view>
                <view class="step-desc">
                  <text class="desc-title">{{item.title}}</text>
                  <text class="desc-subtitle">{{item.subtitle}}</text>
                </view>
              </view>
              <button wx:if="{{item.status !== 'completed'}}" class="step-action {{item.status}}" bindtap="onShoot" data-substep-id="{{item.id}}">{{item.status === 'completed' ? '已完成' : '去拍摄'}}</button>
              <text wx:else class="step-completed">已完成</text>
            </view>
          </view>
        </block>
      </view>

      <!-- 下一个主步骤提示 -->
      <view wx:if="{{shootProgress.currentStep < shootProgress.totalSteps}}" class="next-step">
        <view class="next-content">
          <view class="next-info">
            <text class="info-title">下一步：{{shootProgress.steps[shootProgress.currentStep].name}}讲解</text>
            <text class="info-desc">选择 2-3 个最能打动客户的亮点，AI 将自动生成话术。</text>
          </view>
          <button class="next-button" bindtap="onNextStep">跳转</button>
        </view>
      </view>
    </view>
  </scroll-view>

  <!-- ==================== 底部拍摄控制区域 ==================== -->
  <view wx:if="{{showCameraControls}}" class="camera-control-bar safe-area-padding">
    <view class="control-buttons-container">
      <!-- 切换摄像头按钮 -->
      <button class="control-button switch-camera" bindtap="onRotate">
        <icon class="control-icon" type="refresh" size="24" color="#ffffff"></icon>
      </button>
      
      <!-- 录制按钮 -->
      <button class="record-button {{isRecording ? 'recording' : ''}}" 
              bindtouchstart="onRecordTouchStart" 
              bindtouchend="onRecordTouchEnd"
              bindtouchcancel="onRecordTouchCancel">
        <view class="record-inner"></view>
      </button>
      
      <!-- 相册按钮 -->
      <button class="control-button album" bindtap="onOpenAlbum">
        <icon class="control-icon" type="pic" size="24" color="#ffffff"></icon>
      </button>
    </view>
  </view>
</view>